<!doctype html><html lang=de><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Auf Irrwegen: Gaszähler automatisch auszulesen - noegel.io</title><link rel=stylesheet href=/custom.css><style>.book_cover img{_height:300px!important}.book-gallery figcaption{text-align:left}.modal{display:none;position:fixed;z-index:1000;padding-top:100px;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:#000;background-color:rgba(0,0,0,.9)}.modal-content{margin:auto;display:block;width:80%;max-width:700px}#caption{margin:auto;display:block;width:80%;max-width:700px;text-align:center;color:#ccc;padding:10px 0;height:150px}.modal-content,#caption{animation-name:zoom;animation-duration:.6s}@keyframes zoom{from{transform:scale(0)}to{transform:scale(1)}}.closeModal{z-index:-99999;position:absolute;top:15px;right:35px;color:#f1f1f1;font-size:40px;font-weight:700;transition:.3s}.closeModal:hover,.closeModal:focus{color:#bbb;text-decoration:none;cursor:pointer}@media only screen and (max-width:700px){.modal-content{width:100%}}</style><meta name=Description content="Gaszähler mit ESP32 und einem QMC5883 Sensor automatisch auslesen"><meta name=keywords content="Aqara,Kontakt,QMC5883,HMC5883,Gaszähler,Arduino,ESP32,Reed,Hall,Sensor"><meta property="og:title" content="Auf Irrwegen: Gaszähler automatisch auszulesen"><meta property="og:description" content="Gaszähler mit ESP32 und einem QMC5883 Sensor automatisch auslesen"><meta property="og:type" content="article"><meta property="og:url" content="https://noegel.io/posts/2022-10-12-gaszaehler/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-18T20:46:00+02:00"><meta property="article:modified_time" content="2022-10-18T20:46:00+02:00"><meta property="og:site_name" content="Daniel Nögel"><meta name=twitter:card content="summary"><meta name=twitter:title content="Auf Irrwegen: Gaszähler automatisch auszulesen"><meta name=twitter:description content="Gaszähler mit ESP32 und einem QMC5883 Sensor automatisch auslesen"><meta name=application-name content="Daniel Nögel"><meta name=apple-mobile-web-app-title content="Daniel Nögel"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://noegel.io/posts/2022-10-12-gaszaehler/><link rel=prev href=https://noegel.io/posts/2022-10-09-sungrow/><link rel=next href=https://noegel.io/posts/2022-10-29-heizlastberechnung/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Auf Irrwegen: Gaszähler automatisch auszulesen","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/noegel.io\/posts\/2022-10-12-gaszaehler\/"},"genre":"posts","wordcount":1220,"url":"https:\/\/noegel.io\/posts\/2022-10-12-gaszaehler\/","datePublished":"2022-10-18T20:46:00+02:00","dateModified":"2022-10-18T20:46:00+02:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Daniel"},"description":"Gaszähler mit ESP32 und einem QMC5883 Sensor automatisch auslesen"}</script><script>(function(e,t,n,s,o){s[o]=s[o]||function(){(s[o].q=s[o].q||[]).push(arguments)};var i,a=e.getElementsByTagName(t)[0];if(e.getElementById(n))return;i=e.createElement(t),i.id=n,i.onload=function(){},i.async=!0,i.src="https://cdn.trackboxx.info/p/tracker.js",a.parentNode.insertBefore(i,a)})(document,"script","trackboxx-script",window,"trackboxx"),trackboxx("set","siteId","TB-60422104"),trackboxx("trackPageview")</script><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]]}}</script><script type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></head><body data-header-desktop=fixed data-header-mobile=auto><div id=myModal class=modal><span class=closeModal>&#215;</span>
<img class=modal-content id=img01><div id=caption></div></div><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=noegel.io>noegel.io</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/about/>About </a><a class=menu-item href=/read/>Reading </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=noegel.io>noegel.io</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/about/ title>About</a><a class=menu-item href=/read/ title>Reading</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Auf Irrwegen: Gaszähler automatisch auszulesen</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Daniel</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-10-18>2022-10-18</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;1220 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;6 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#warum-das-ganze>Warum das Ganze</a></li><li><a href=#das-grundprinzip>Das Grundprinzip</a></li><li><a href=#versuch-1-der-aqara-tür--und-fensterkontakt>Versuch 1: Der Aqara Tür- und Fensterkontakt</a></li><li><a href=#versuch-2-ip-webcam>Versuch 2: IP Webcam</a></li><li><a href=#versuch-3-kompass>Versuch 3: Kompass</a></li><li><a href=#fazit>Fazit</a></li></ul></nav></div></div><div class=content id=content><p>Smart Home und der mitleidige Blick meiner Ehefrau, wenn ich ihr mal wieder eine Automatisierung oder eine neue Sensorüberwachung präsentiere: Diese beiden Sachen gehen Hand in Hand. Das war auch wieder bei diesem Projekt der Fall: Der automatischen Überwachung des Gaszählers.</p><h2 id=warum-das-ganze>Warum das Ganze</h2><p>Ich erfasse immer schon monatlich unseren Strom- und Gasverbrauch. Bisher händisch: Einmal im Monat ein Foto von beiden Zählern - und bei Zeiten dann in Excel eingepflegt. Fertig. Im Rahmen der Dämmung unseres Hauses sowie der Heizlastberechnung wollte ich aber genauer verstehen, wie (schnell) sich der Erdgasverbauch entwickelt.</p><p>Wie so oft: Das Ganze war doch komplizierter als gedacht.</p><h2 id=das-grundprinzip>Das Grundprinzip</h2><p>In einigen Gaszählern - so auch in meinem G4 RF1 - finden sich Magneten in einer Walze der Segmentanzeige. Positioniert man einen Reed-Kontakt an die richtige Position, kann dieser recht zuverlässig detektieren, wenn sich die Walze beispielsweise von 9 nach 0 weiter dreht, weil dann eben auch der Magnet am Kontakt vorbeigeführt wird. Passende Kontakte / Sensoren gibt es direkt vom Hersteller - der lässt sich das mit 50-60€ aber auch gut vergüten. In solchen Fällen ist &ldquo;selber machen&rdquo; immer eine gute Option - und auch mindestens eine ebensogute Ausrede, den gleichen Betrag in Zubehör und Werkzeug zur Umsetzung des Projektes zu investieren ;-).</p><p>In meinem Fall ist auf dem Gaszähler übrigens vermerkt, dass 1 Impuls 0,1m³ entspricht - demzufolge findet sich der Magnet auf der zweiten Walze nach dem Komma (eine volle Umdrehung der zweiten Nachkommastelle entspricht einem 1er-Inkrement der ersten Nachkommastelle).</p><h2 id=versuch-1-der-aqara-tür--und-fensterkontakt>Versuch 1: Der Aqara Tür- und Fensterkontakt</h2><p>Im Netz finden sich verschiedene Berichte, dass ein Aqara Tür- und Fensterkontakt genutzt werden kann, um die Impulse zu messen. Diese Lösung wäre natürlich besonders charmant, da ich (a) solche Kontakte ohnehin zu Hause habe, (b) die Sensoren sehr lange batteriebetrieben laufen und sie (c) sehr einfach über Zigbee in das bestehende Hausautomatisierungssystem eingebunden werden können.</p><p>Die Idee ist einfach: Sensor aus der Plastikhülle befreien, an die richtige Stelle auf den Gaszähler platzieren - fertig…</p><p>…oder auch nicht.</p><div class=gallery-grid><figure style=font-size:small><img src=/images/gaszaehler/closed.jpeg><figcaption>Aquara Tür- und Fenstersensor im Auslieferungszustand</figcaption></figure><figure style=font-size:small><img src=/images/gaszaehler/open1.jpeg><figcaption>Die untere Kappe des Kontaktes lässt sich leicht öffnen</figcaption></figure><figure style=font-size:small><img src=/images/gaszaehler/open2.jpeg><figcaption>Mit einem Messer lässt sich auch leicht der Rest zerstörungsfrei öffnen (anders als im Bild gezeigt ;-))</figcaption></figure><figure style=font-size:small><img src=/images/gaszaehler/implemented.jpeg><figcaption>Der Sensor wird in die entsprechende Aufnahme platziert. Das Glasröhrchen mit dem Reed-Kontakt sollte grob oberhalb der zweiten Nachkommastelle liegen, da sich in dieser Walze der Magnet befindet</figcaption></figure><figure style=font-size:small><img src=/images/gaszaehler/implemented2.png><figcaption>Kein Signal: Die nächsten Tage habe ich den Sensor in alle möglichen und unmöglichen Positionen und Ausrichtungen an den Gaszähler geklebt. Ohne Erfolg</figcaption></figure></div><p>Trotz aller Bemühungen - und gut 10 abenteuerlichen Klebepositionen: Der Sensor erkennt den Magneten nicht, egal wie oft dieser im Betrieb am Sensor vorüber zieht. Das Problem ist bekannt - nicht jede Kombination aus Gaszählerfabrikat und Aqara-Sensor scheint zu funktionieren.</p><h2 id=versuch-2-ip-webcam>Versuch 2: IP Webcam</h2><p>Im nächsten Versuch sollte ein altes Handy als IP Webcam herhalten - ehrlicherweise nur um die Zeit zu überbrücken, bis das Zubehör für Versuch 3 eingetroffen ist. Mit einer <a href="https://play.google.com/store/apps/details?id=com.pas.webcam&hl=de&gl=US" target=_blank rel="noopener noreffer">entsprechenden App</a> lassen sich alte Android Geräte relativ leicht als IP Webcam betreiben. Die App bietet umfangreiche Konfigurationsoptionen, letztlich benötige ich aber nur folgende Gegebenheiten:</p><ul><li>Bild lässt sich via URL auslesen</li><li>LED-Licht lässt sich via HTTP-API ein- und abschalten</li></ul><p>So bekomme ich nun stündlich einen aktuellen Zählerstand via Telegram-Nachricht mitgeteilt - dank LED Licht auch in der Nacht gut lesbar. Nur aus Interesse habe ich versucht, die Bilder auch automatisiert auszuwerten - zumindest via <a href=https://www.unix-ag.uni-kl.de/~auerswal/ssocr/ target=_blank rel="noopener noreffer">SSOCR</a> ist es mir aber nicht gelungen. Würde man so etwas zum Laufen bringen <em>wollen</em> - ein Blick auf <em><a href=https://github.com/jomjol/AI-on-the-edge-device target=_blank rel="noopener noreffer">AI on the edge</a></em> wäre sicher lohnenswert: Dort werden Wasserzähler mittels ESP32 und einem neuronalem Netzwerk ausgelesen. Entsprechende Trainingsdaten inklusive…</p><div class=gallery-grid><figure style=font-size:small><img src=/images/gaszaehler/handy.png><figcaption>Ein ausgemustertes Handy überwacht den Gaszähler</figcaption></figure><figure style=font-size:small><img src=/images/gaszaehler/in.png style=margin-top:50px><figcaption>Der Versuch die Bilder automatisch zu verarbeiten…</figcaption><img src=/images/gaszaehler/out.png style=margin-bottom:50px><figcaption>scheitert aber: SSOCR erkennt maximal 3 Ziffern</figcaption></figure><figure style=font-size:small><img src=/images/gaszaehler/blockly.png><figcaption>Wenn es schon mit der automatischen Auswertung nicht klappt: Dieses Blockly schickt stündlich…</figcaption></figure><figure style=font-size:small><img src=/images/gaszaehler/telegram.png><figcaption>…Telegram-Nachrichten mit dem aktuellen Zählerstand 🥴</figcaption></figure></div><p>Eine Erkenntnis ist aber: Alte Handys lassen sich doch sehr gut als IP Webcam umfunktionieren: Bewegungserkennung, Zwei-Wege-Kommunikation, LED-Licht, Video, Automatische Aufnahmen… alles möglich.</p><h2 id=versuch-3-kompass>Versuch 3: Kompass</h2><p>Nachdem klar war, dass der Sensor des Aqara-Kontaktes nicht fein genug ist, um den Magneten zu registrieren, habe ich nach Alternativen geschaut. Die Optionen:</p><ul><li>Reed-Kontakt</li><li>Hall-Sensor</li><li>Kompass/Magnetometer</li></ul><p>Nachdem ich mit dem Reed-Kontakt im Aqara-Sensor schon auf die Nase gefallen war, habe ich zunächst in Richtung Hall-Sensor überlegt. Auch hier finden sich aber unterschiedliche Berichte, welcher Sensor für diesen Zweck jetzt empflindlich genug ist. Zu guter Letzt habe ich aber ein Projekt gefunden, wo ein <a href=https://www.kompf.de/tech/gascountmag.html target=_blank rel="noopener noreffer">Magnetometer HMC5883 mit Raspberry Pi</a> die Aufgabe übernimmt. Die Überlegung, dass ein Sensor, der das Erdmagnetfelt detektieren kann, auch den Magneten im Gaszähler detektieren können sollte, fand ich plausibel.</p><figure style=font-size:small;width:500px;margin:auto><img src=/images/gaszaehler/soldering.jpeg><figcaption>Der Sensor QMC5883 wird mit Stifleisten versehen</figcaption></figure><p>Nachdem ich den ersten Sensor beim Anlöten der Stiftleisten frittiert hatte und die Ersatzlieferung eingetroffen war, konnte das Projekt umgesetzt werden.</p><p>Material:</p><ul><li>ESP32 Microprozessor</li><li>QMC5833 Kompass</li><li>Breadboard</li><li>Jumperkabel</li></ul><p>Werkzeug:</p><ul><li>Lötkolben</li></ul><p>Die Idee: Der ESP32 wählt sich ins Wifi ein und übermittelt die Impulse via MQTT an meine Iobroker-Instanz, wo bei jedem Impuls der Zählerstand um 0,1m³ erhöht wird.</p><figure style=font-size:small;width:640px;margin:auto><video width=640 height=360 controls>
<source src=/images/gaszaehler/GasMeter.mp4 type=video/mp4></video><figcaption>Springt die zweite Nachkommastelle von 6 auf 7 (rechts im Video), erkennt der Kompass einen starken Ausschlag (links im Video). So lassen sich wiederum Inkremente der ersten Nachkommastelle detektieren</figcaption></figure><p>Nachdem die grundlegende Funktionsweise sichergestellt wurde (etwas Malerkrepp hält den Sensor an Ort und Stelle), habe ich noch einen kleinen Halter 3d-gedruckt, dessen Modell auf Thingiverse abrufbar ist: <a href=https://www.thingiverse.com/thing:5581975 target=_blank rel="noopener noreffer">https://www.thingiverse.com/thing:5581975</a></p><figure style=font-size:small;width:500px;margin:auto><img src=/images/gaszaehler/result.jpeg><figcaption>Mittels eines 3d-gedruckten Halters wird der Sensor genau über die zweite Nachkommastelle der Segmentanzeige positioniert.</figcaption></figure><figure style=font-size:small;width:640px;margin:auto><video width=500 controls>
<source src=/images/gaszaehler/3dmodel.mov type=video/mp4></video><figcaption>Das Modell in der Rundumansicht</figcaption></figure><p>Das Sketch für das Projekt ist relativ simpel: Im Wesentlichen werden 10 Sekunden lang Messwerte des Magnetfeldes gesammelt. Da der Sensor relativ empfindlich ist und die Werte bei Erkennung des Magneten überlaufen können, wird die Signalstärke auf 4000 beschränkt. Ist der Durchschnittswert der letzten 10 Sekunden > 2000, wird das <code>high</code> Flag gesetzt. Ist der Durchschnittswert der letzten 10 Sekunden kleiner 300 und das High-Flag ist gesetzt, wurde eine Rotation erkannt, das <code>high</code> Flag wird entfernt und das Ganze via MQTT publiziert. Die Erkennung basiert also auf Anstieg und anschließendem Fall der gemessenen Feldstärke. Dieses Vorgehen erscheint mir relativ robust, weil es wenig Fehlauslösungen gibt - selbst wenn der Magnet längere Zeit direkt unter dem Sensor stehen bleibt. Das wäre anders, wenn der Trigger für <code>high</code> und der Trigger für <code>low</code> identisch wären - bei ungünstiger Positionierung des Magneten könnte der Sensor zwischen den Auslösewerten hin- und herspringen.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>loop</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  loopMqtt();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  sVector_t mag <span style=color:#f92672>=</span> compass.readRaw();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// calculate field strength &amp; store for average calculation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  fieldStrength <span style=color:#f92672>=</span> sqrt(mag.XAxis <span style=color:#f92672>^</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>+</span> mag.YAxis <span style=color:#f92672>^</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>+</span> mag.ZAxis <span style=color:#f92672>^</span> <span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>  avg <span style=color:#f92672>=</span> avgFieldStrength.reading(fieldStrength <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>4000</span> <span style=color:#f92672>?</span> <span style=color:#ae81ff>4000</span> <span style=color:#f92672>:</span> fieldStrength);
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  Serial.print(<span style=color:#e6db74>&#34;Arrow: &#34;</span>); Serial.println(fieldStrength);  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// every 10 seconds: evaluate if signall falls from high (magnet detected) to low (no magnet)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> ((<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span>)(millis() <span style=color:#f92672>-</span> timer) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>10000</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (avg <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>300</span> and isHigh) {
</span></span><span style=display:flex><span>      isHigh <span style=color:#f92672>=</span> false;
</span></span><span style=display:flex><span>      client.publish(<span style=color:#e6db74>&#34;mqtt.0.gas_meter.tick&#34;</span>, itoa(millis(), charBuf, <span style=color:#ae81ff>10</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (avg <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>2000</span>) {
</span></span><span style=display:flex><span>      isHigh <span style=color:#f92672>=</span> true;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    timer <span style=color:#f92672>=</span> millis();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  delay(<span style=color:#ae81ff>500</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Das <a href=https://github.com/dnoegel/gasmeter-sensor target=_blank rel="noopener noreffer">komplette Skript findet sich auf Github</a>.</p><h2 id=fazit>Fazit</h2><p>Insgesamt bin ich ziemlich zufrieden mit dem Ergebnis: Nach etwas Feinjustierung gibt es auch über mehrere Tage keine Abweichung, der erfasste Zählerstand entspricht (bis auf die erste Nachkommastelle) genau dem tatsächlichen Zählerstand. Und via Iobroker/Jarvis kann ich den Tagesverbauch auch sehr leicht graphisch visualisieren lassen.</p><figure style=font-size:small;width:100%;margin:auto><img src=/images/gaszaehler/graph.png><figcaption>Nach 24 Stunden hat der Sensor alle 16 Ticks korrekt erfasst</figcaption></figure></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2022-10-18</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://noegel.io/posts/2022-10-12-gaszaehler/ data-title="Auf Irrwegen: Gaszähler automatisch auszulesen" data-via=danielnoegel><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://noegel.io/posts/2022-10-12-gaszaehler/><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://noegel.io/posts/2022-10-12-gaszaehler/ data-title="Auf Irrwegen: Gaszähler automatisch auszulesen"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://noegel.io/posts/2022-10-12-gaszaehler/ data-title="Auf Irrwegen: Gaszähler automatisch auszulesen"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://noegel.io/posts/2022-10-12-gaszaehler/ data-title="Auf Irrwegen: Gaszähler automatisch auszulesen"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/2022-10-09-sungrow/ class=prev rel=prev title="Sungrow Wechselrichter mit Modbus in Iobroker in Echtzeit auslesen"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Sungrow Wechselrichter mit Modbus in Iobroker in Echtzeit auslesen</a>
<a href=/posts/2022-10-29-heizlastberechnung/ class=next rel=next title="Heizlastberechnung - Teil 1: Heizlast eines Raumes und Hauses ermitteln">Heizlastberechnung - Teil 1: Heizlast eines Raumes und Hauses ermitteln<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.104.3">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><span class=imprint><a href=https://noegel.io/data-privacy/>Datenschutz</a></span><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank></a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:60,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body><script>document.getElementsByTagName("figure");var list=document.getElementsByTagName("figure"),idx,img,caption,modal=document.getElementById("myModal"),captionText=document.getElementById("caption"),modalImg=document.getElementById("img01"),span=document.getElementsByClassName("closeModal")[0];modal.isVisible=!1,idx=-1;for(let e of list){if(idx++,img=e.getElementsByTagName("img")[0],img===void 0)continue;if(img.idx=idx,caption=e.getElementsByTagName("figcaption")[0],caption!==void 0&&(img.alt=caption.innerText),e.className==="book_cover")continue;img.onclick=function(){modalShow(this)}}span.onclick=function(){modalHide()},modal.onclick=function(){modalHide()};function modalShow(e){modal.style.display="block",modalImg.src=e.src,captionText.innerHTML=e.alt,modal.imgIdx=e.idx,modal.isVisible=!0}function modalHide(){modal.style.display="none",modal.isVisible=!1}function showImage(e){var n=list[e],t=n.getElementsByTagName("img")[0];if(t===void 0)return;modalShow(t)}document.onkeydown=function(e){e=e||window.event;var t,n,s=!1;"key"in e?(t=e.key==="Escape"||e.key==="Esc",n=e.key==="ArrowLeft",s=e.key==="ArrowRight"):(t=e.keyCode===27,n=e.keyCode===37,s=e.keyCode===39),t&&modalHide(),modal.isVisible&&(s&&showImage(Math.min(modal.imgIdx+1,list.length-1)),n&&showImage(Math.max(0,modal.imgIdx-1)))}</script></html>