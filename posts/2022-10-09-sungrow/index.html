<!doctype html><html lang=de><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Sungrow Wechselrichter mit Modbus in Iobroker in Echtzeit auslesen - noegel.io</title><link rel=stylesheet href=/custom.css><style>.book_cover img{_height:300px!important}.book-gallery figcaption{text-align:left}.modal{display:none;position:fixed;z-index:1000;padding-top:100px;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:#000;background-color:rgba(0,0,0,.9)}.modal-content{margin:auto;display:block;width:80%;max-width:700px}#caption{margin:auto;display:block;width:80%;max-width:700px;text-align:center;color:#ccc;padding:10px 0;height:150px}.modal-content,#caption{animation-name:zoom;animation-duration:.6s}@keyframes zoom{from{transform:scale(0)}to{transform:scale(1)}}.closeModal{z-index:-99999;position:absolute;top:15px;right:35px;color:#f1f1f1;font-size:40px;font-weight:700;transition:.3s}.closeModal:hover,.closeModal:focus{color:#bbb;text-decoration:none;cursor:pointer}@media only screen and (max-width:700px){.modal-content{width:100%}}</style><meta name=Description content="Sungrow Wechselrichter mit Modbus in Iobroker in Echtzeit auslesen"><meta name=keywords content="Sungrow,Inverter,Modbus,Iobroker,Wechselrichter"><meta property="og:title" content="Sungrow Wechselrichter mit Modbus in Iobroker in Echtzeit auslesen"><meta property="og:description" content="Sungrow Wechselrichter mit Modbus in Iobroker in Echtzeit auslesen"><meta property="og:type" content="article"><meta property="og:url" content="https://noegel.io/posts/2022-10-09-sungrow/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-09T14:50:27+02:00"><meta property="article:modified_time" content="2022-10-09T14:50:27+02:00"><meta property="og:site_name" content="Daniel Nögel"><meta name=twitter:card content="summary"><meta name=twitter:title content="Sungrow Wechselrichter mit Modbus in Iobroker in Echtzeit auslesen"><meta name=twitter:description content="Sungrow Wechselrichter mit Modbus in Iobroker in Echtzeit auslesen"><meta name=application-name content="Daniel Nögel"><meta name=apple-mobile-web-app-title content="Daniel Nögel"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://noegel.io/posts/2022-10-09-sungrow/><link rel=next href=https://noegel.io/posts/2022-10-12-gaszaehler/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Sungrow Wechselrichter mit Modbus in Iobroker in Echtzeit auslesen","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/noegel.io\/posts\/2022-10-09-sungrow\/"},"genre":"posts","wordcount":2176,"url":"https:\/\/noegel.io\/posts\/2022-10-09-sungrow\/","datePublished":"2022-10-09T14:50:27+02:00","dateModified":"2022-10-09T14:50:27+02:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Daniel"},"description":"Sungrow Wechselrichter mit Modbus in Iobroker in Echtzeit auslesen"}</script><script>(function(e,t,n,s,o){s[o]=s[o]||function(){(s[o].q=s[o].q||[]).push(arguments)};var i,a=e.getElementsByTagName(t)[0];if(e.getElementById(n))return;i=e.createElement(t),i.id=n,i.onload=function(){},i.async=!0,i.src="https://cdn.trackboxx.info/p/tracker.js",a.parentNode.insertBefore(i,a)})(document,"script","trackboxx-script",window,"trackboxx"),trackboxx("set","siteId","TB-60422104"),trackboxx("trackPageview")</script></head><body data-header-desktop=fixed data-header-mobile=auto><div id=myModal class=modal><span class=closeModal>&#215;</span>
<img class=modal-content id=img01><div id=caption></div></div><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=noegel.io>noegel.io</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/about/>About </a><a class=menu-item href=/read/>Reading </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=noegel.io>noegel.io</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/about/ title>About</a><a class=menu-item href=/read/ title>Reading</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Sungrow Wechselrichter mit Modbus in Iobroker in Echtzeit auslesen</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Daniel</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-10-09>2022-10-09</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;2176 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;11 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#kurze-einführung>Kurze Einführung</a></li><li><a href=#einrichtung>Einrichtung</a><ul><li><a href=#verbindung>Verbindung</a></li><li><a href=#installation-in-iobroker>Installation in IoBroker</a></li><li><a href=#verbindungseinstellungen>Verbindungseinstellungen</a></li><li><a href=#eingangsregister>Eingangsregister</a></li><li><a href=#prüfen>Prüfen</a></li></ul></li><li><a href=#fehlerbehandlung>Fehlerbehandlung</a><ul><li><a href=#fehleranalyse-mit-modbus-cli>Fehleranalyse mit modbus-cli</a></li><li><a href=#richtiges-gerät-finden>Richtiges Gerät finden</a></li><li><a href=#verbindungsfehler>Verbindungsfehler</a></li><li><a href=#reduzierung-von-abfrageintervallen-und-registeranzahl>Reduzierung von Abfrageintervallen und Registeranzahl</a></li></ul></li><li><a href=#jetzt-wird-ausgelesen>Jetzt wird ausgelesen!</a><ul><li><a href=#13000_running_state>13000_Running_State</a></li><li><a href=#wohin-fließt-der-strom>Wohin fließt der Strom?</a></li><li><a href=#regelverluste>Regelverluste</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>Endlich ist es soweit: 9,75kwp Photovoltaik schimmern im Sonnenlicht auf dem Dach - mit Wechselrichter und Speicher von Sungrow. Die nützliche App des Anbieters mit all ihren Analysemöglichkeiten kann aber nur kurz den Wunsch nach einem direkteren Zugriff auf die Daten zwecks Einbindung in die Hausautomatisierung stillen. Nach einigem Experimentieren funktioniert der Zugriff nun - die Erfahrung möchte ich teilen.</p><h2 id=kurze-einführung>Kurze Einführung</h2><p>Über die Modbus-Schnittstelle des Wechselrichters können verschiedene Daten der Photovoltaik-Anlage ermittelt werden, wie beispielsweise:</p><ul><li>Ertrag der Anlage (Momentan und Tagessumme)</li><li>Eigenbedarf (Momentan und Tagessumme)</li><li>Einspeisung/Bezug ins/aus dem Netz (Momentan und Tagessumme)</li><li>Lade- und Entladestrom der Batterie (Momentan und Tagessumme)</li><li>Verschiedene Monatswerte</li><li>Spannung und Strom der Strings</li><li>Ladestand der Anlage</li></ul><p>Aktuell lese ich etwa 100 Werte aus - davon werden natürlich nicht alle benötigt. Grundsätzlich ist der Modbus-Standard unabhängig von der eingesetzten Hausautomatisierungslösung - ich nutze in meinem Fall Iobroker, auch mit anderen Tools und Skripten lassen sich die Daten bei Bedarf verarbeiten.</p><h2 id=einrichtung>Einrichtung</h2><h3 id=verbindung>Verbindung</h3><p>Beim Standard &ldquo;Modbus über TCP&rdquo; kann das Modbus-Gerät (hier: der Wechselrichter) einfach über das Heimnetz verbunden werden. Sungrow bietet für die hier beschriebenen Wechselrichter unterschiedliche Arten der Verbindung an:</p><ul><li>LAN-Verbindung direkt am Wechselrichter</li><li>LAN-Verbindung via WiNet-S Dongle</li><li>Wifi-Verbindung via WiNet-S Dongle</li></ul><p>Gemäß verschiedenen Foren-Berichten, die auf den Sungrow-Support verweisen, sowie meiner eigenen Erfahrung ist eine Modbus-Verbindung <strong>NUR via LAN-Anschluss direkt am Wechselrichter</strong> möglich. Der Wechselrichter wird also direkt via LAN-Kabel mit dem Router/Switch im Heimnetz verbunden.</p><h3 id=installation-in-iobroker>Installation in IoBroker</h3><p>Installiere den Modbus-Adapter in IoBroker indem ihr im Reiter <em>Instanzen</em> nach <em>Modbus</em> sucht und den Adapter installiert.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/modbus/modbus-adapter.png data-srcset="/images/modbus/modbus-adapter.png, /images/modbus/modbus-adapter.png 1.5x, /images/modbus/modbus-adapter.png 2x" data-sizes=auto alt=/images/modbus/modbus-adapter.png title=/images/modbus/modbus-adapter.png></p><h3 id=verbindungseinstellungen>Verbindungseinstellungen</h3><p>Unter <em>Instanzen</em>-><em>Modbus</em> kann der Adapter nun konfiguriert werden. Im Tab <em>Allgemein</em> werden folgende Daten hinterlegt:</p><ul><li>Partner IP-Adresse: IP eures Sungrow WRs</li><li>Port: 502</li><li>Geräte ID: 1, ggf. abweichend</li><li>Typ: Master</li><li>Aliases benutzen: Deaktivieren / Nein</li></ul><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/modbus/adapter.png data-srcset="/images/modbus/adapter.png, /images/modbus/adapter.png 1.5x, /images/modbus/adapter.png 2x" data-sizes=auto alt=/images/modbus/adapter.png title=/images/modbus/adapter.png></p><h3 id=eingangsregister>Eingangsregister</h3><p>Die vom Wechselrichter bereitgestellten Informationen müssen aus sog. <em>Registern</em> ausgelesen werden. Für die Anbindung müssen neben Adresse und Datentyp auch Länge und Faktor hinterlegt sein, idealerweise auch Einheit und eine kurze Beschreibung zur späteren Identifikation.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/modbus/register.png data-srcset="/images/modbus/register.png, /images/modbus/register.png 1.5x, /images/modbus/register.png 2x" data-sizes=auto alt=/images/modbus/register.png title=/images/modbus/register.png></p><p>Da das händische Hinterlegen der Register nicht praktikabel ist, können diese auch importiert werden. Über den Doppelpfeil (zweites Icon von links auf der linken Seite) können die Register als TSV (Tab seperated Value) hinterlegt werden. Ein TSV mit den Registern ist <a href=https://gist.github.com/dnoegel/543c72ef722365a3934bbad0bb43e222 target=_blank rel="noopener noreffer">hier zu finden</a>. Dort auf &ldquo;Raw&rdquo; klicken um <a href=https://gist.githubusercontent.com/dnoegel/543c72ef722365a3934bbad0bb43e222/raw/17c23638b60035d7ee9201286c95576692a29b8b/sungrow_modbus_register.tsv target=_blank rel="noopener noreffer">zum TSV zu gelangen</a>.</p><p>Nach dem Einrichten kann die Konfiguration gespeichert werden.</p><h3 id=prüfen>Prüfen</h3><p>Im Navigationsbaum kann nun <em>Objekte</em> geöffnet werden. Unter <code>modbus.0.inputRegisters</code> sollten sich nun die Datenpunkte finden.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/modbus/registers-in-object-tab.png data-srcset="/images/modbus/registers-in-object-tab.png, /images/modbus/registers-in-object-tab.png 1.5x, /images/modbus/registers-in-object-tab.png 2x" data-sizes=auto alt=/images/modbus/registers-in-object-tab.png title=/images/modbus/registers-in-object-tab.png></p><p>Hier sollte recht schnell ersichtlich werden, ob die Verbindung funktioniert, bspw. anhand der Register 13001 (PV Erzeugung heute) oder 13007 (Wirkleistung). Sind hier keine oder falsche Werte zu sehen, gibt es Probleme mit der Verbindung. Unter <em>Protokoll</em> in der Navigation finden sich weitere Informationen dazu.</p><h2 id=fehlerbehandlung>Fehlerbehandlung</h2><p>Die Modbus-Verbindung des Wechselrichters erscheint teilweise etwas fragil. Im Iobroker-Forum gibt es viele Berichte von Verbindungsproblemen aller Art. Im Folgenden ein paar Tipps dazu:</p><h3 id=fehleranalyse-mit-modbus-cli>Fehleranalyse mit modbus-cli</h3><p>Um zu prüfen ob zumindest die Verbindung zum Wechselrichter funktioniert, können Modbus Tools wie bspw. <a href=https://github.com/favalex/modbus-cli target=_blank rel="noopener noreffer">Modbus-CLI</a> genutzt werden.</p><p>Ein einfaches Beispiel:</p><pre tabindex=0><code>daniel@laptop ~ % modbus 192.168.1.123:502 -s 1 4999   
</code></pre><ul><li><code>192.168.1.123</code>: Durch deine IP ersetzen</li><li><code>502</code>: Modbus Port am WR, idR 502</li><li><code>-s 1</code>: Eure ClientID, idR <code>1</code> oder <code>100</code></li><li><code>4999</code>: Das Register das ausgelesen werden soll</li></ul><p>Das Ergebnis sollte nun wie folgt aussehen</p><pre tabindex=0><code>Parsed 0 registers definitions from 1 files
4999: 2022 0x7e6
</code></pre><p>Interpretation der Rückgabe:</p><ul><li><code>4999</code>: Das ausgelesene Register</li><li><code>2022</code>: Der Wert in dezimal. Hier: Das aktuelle Jahr 2022</li><li><code>0x7e6</code>: Der Wer in hexadezimal.</li></ul><p>Anstatt des Register <code>4999</code> können natürlich auch <a href=https://gist.githubusercontent.com/dnoegel/543c72ef722365a3934bbad0bb43e222/raw/17c23638b60035d7ee9201286c95576692a29b8b/sungrow_modbus_register.tsv target=_blank rel="noopener noreffer">beliebige andere Register</a> ausgelesen werden. <strong>Aber Achtung</strong>: Die Erfahrung zeigt, dass es gerade mit diesem Tool nicht immer leicht ist, die richtigen Datentypen zu hinterlegen - selbst bei korrekter Verbindung kommen so fehlerhafte Rückgaben zu stande. Meine Empfehlung daher: Nutzt das Tool eher um sicherzustellen, dass die Verbindung funktioniert und haltet euch nicht damit auf, andere Werte auslesen zu wollen.</p><h3 id=richtiges-gerät-finden>Richtiges Gerät finden</h3><figure style=float:right><img src=/images/modbus/winet-s.png style=width:200px><figcaption>Antwortet der Einrichtungsassistent<br>ist die IP-Adresse <strong>falsch</strong></figcaption></figure><p>In der Regel werdet ihr den Wechselrichter via WLAN-Stick mit dem Internet verbunden haben und zusätzlich über den direkten Anschluss die Modbus-Verbindung vornehmen. Damit hat der Wechselrichter zwei IPs - einmal via WLAN und einmal via LAN. Über beide IPs ist Modbus auch (theoretisch) erreichbar - ihr müsst nun sicherstellen, dass ihr Modbus über den LAN-Anschluss konfiguriert.</p><p>Die korrekte IP kann bspw. über Fritzbox gefunden werden: Dort lassen sich unter <em>Heimnetz</em>-><em>Netzwerk</em> alle Netzwerk-Geräte finden. Die Sungrow-Geräte haben in der Regel eine Mac-Adresse, die mit &ldquo;AC&rdquo; beginnt (Mac-Adressen ggf. über den mit &ldquo;+/-&rdquo; beschrifteten Button oben rechts anzeigen lassen). Weiterhin scheinen sich die Geräte als <em>espressif-sungrow</em> oder <em>espressif</em> zu identifizieren.</p><p>Alternativ kann auch das Netzwerk recht einfach mit <code>nmap</code>nach Geräten durchsucht werden, die auf Port 502 (Modbus) lauschen:</p><pre tabindex=0><code>daniel@rechner ~ % nmap -p502 --open 192.168.178.1/24   
Starting Nmap 7.92 ( https://nmap.org ) at 2022-10-10 13:33 CEST
Nmap scan report for espressif.fritz.box (192.168.178.85)
Host is up (0.13s latency).

PORT    STATE SERVICE
502/tcp open  mbap

Nmap scan report for espressif-sungrow.fritz.box (192.168.178.89)
Host is up (0.22s latency).

PORT    STATE SERVICE
502/tcp open  mbap

Nmap done: 256 IP addresses (24 hosts up) scanned in 49.12 seconds
daniel@rechner ~ % 
</code></pre><p>Auch hier fördert der Scan zwei IPs zu Tage. Welche die richtige ist, offenbart ein einfacher Test: Ruft ihr die IP-Adresse im Browser auf und euch wird ein Setup-Assistent angezeigt, seit ihr mit dem WLAN-Stick verbunden - die IP ist also nicht die richtige für die Modbus-Verbindung.</p><h3 id=verbindungsfehler>Verbindungsfehler</h3><p>Gefürchtet sind Modbus-Fehler wie</p><pre tabindex=0><code>error: modbus.0 (21335) Client in error state.
warn: modbus.0 (21335) Poll error count: 1 code: {&#34;err&#34;:&#34;timeout&#34;,&#34;timeout&#34;:5000}
</code></pre><p>oder in meinem Fall auch gerne</p><pre tabindex=0><code>On error: {&#34;errno&#34;:-104,&#34;code&#34;:&#34;ECONNRESET&#34;,&#34;syscall&#34;:&#34;read&#34;}
</code></pre><p>im Iobroker-Protokoll. Eine genaue Ursache scheint nicht immer ersichtlich, empfohlen werden folgende Maßnahmen:</p><ul><li>Penible(!) Prüfung der <a href=#verbindungseinstellungen rel>Konfiguration</a></li><li>Sicherstellen dass die Read- und Write-Register keine Fehler enthalten (ggf. alle bis auf ein Register probeweise entfernen)</li><li>Neuinstallation des Modbus-Adapters (Konfiguration, insb. Register vorher sichern / kopieren)</li><li>Neustart Wechselrichter</li><li>Aktualisierung Firmware Wechselrichter</li><li>Umstecken das Kabels in anderen Switch-Port (in meinem Fall Zyxel, ggf. haben die vielen MODBUS Anfragen ein Limit gerissen?) => Hat reproduzierbar und mit sofortiger Wirkung zu einer Wiederherstellung der Verbindung geführt</li></ul><h3 id=reduzierung-von-abfrageintervallen-und-registeranzahl>Reduzierung von Abfrageintervallen und Registeranzahl</h3><p>Gerade wenn die Verbindung nach einigen Tagen abbricht und durch Wahl eines anderen LAN-Ports am Router/Switch wiederhergestellt werden kann, sollte geprüft werden, ob nicht ggf. eine zu große Zahl an Registern in zu kurzer Zeit gelesen wird. Mögliche Abhilfe:</p><ul><li>Reduzierte Anzahl an Registern (Beispiel <a href=https://gist.github.com/dnoegel/6ac76fdbd3dd4e2425162207508cbd53 target=_blank rel="noopener noreffer">Gist</a> / <a href=https://gist.githubusercontent.com/dnoegel/6ac76fdbd3dd4e2425162207508cbd53/raw/825e54a8613d70286d8e4b0a99d1c97d33fb4b8f/sungrow_modbus_register_reduced.tsv target=_blank rel="noopener noreffer">RAW</a>)</li><li>Reduzierte Anzahl an Lese- und Schreiboperationen im Modbus-Adapter durch Anpassung der Konfigirationen <code>Leseinterval</code>, <code>Wartezeit</code></li></ul><h2 id=jetzt-wird-ausgelesen>Jetzt wird ausgelesen!</h2><p>Ist der WR korrekt in IoBroker eignebunden, ist die Freude zu nächst groß. Register wie</p><ul><li>5016 Total DC Power</li><li>13007 Load power</li><li>13009 Export power</li><li>13021 Battery power</li></ul><p>versprechen schnelle Erfolge. Allerdings stehen nicht alle Werte, die in der App ersichtlich sind, auch direkt zum Auslesen zur Verfügung:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/modbus/sungrow-app.png data-srcset="/images/modbus/sungrow-app.png, /images/modbus/sungrow-app.png 1.5x, /images/modbus/sungrow-app.png 2x" data-sizes=auto alt=/images/modbus/sungrow-app.png title=/images/modbus/sungrow-app.png></p><p>Im obigen Bild ist bspw. ersichtlich, dass die Last des Hauses mit 83 W aus der PV-Anlage sowie 133 W aus dem Akku bedient wird. Weiterhin speist der Akku mit 2,003 kW ins Netz ein (es handelt sich hierbei um eine Kalibrierung des AKkus, ansonsten tritt der Fall natürlich nicht auf).
Mit den Informationen in den o.g. Registern ist lediglich ersichtlich, dass 83 W PV-Strom erzeugt werden, die Batterie eine Last von 2,136 kW hat und ins Netz 2,003 kW eingespeist werden und im Haus eine Last von 216 W anfällt. Wie die Ströme sich genau verteilen ist über die Register <em>nicht</em> ersichtlich.</p><p>Um diese Information zu ermitteln werden die sog. &ldquo;Running States&rdquo; benötigt.</p><h3 id=13000_running_state>13000_Running_State</h3><p>Im Register <code>13000</code> &ldquo;Running State&rdquo; findet sich der aktuelle Betriebsstatus des Wechselrichters. Hierbei handelt es sich um eine Bitmaske die folgende Informationen kodiert:</p><ul><li><p>Bit0 PV power</p><ul><li>Bit0 == 0 No power generated from PV</li><li>Bit0 == 1 Power generated from PV</li></ul></li><li><p>Bit1 Battery charging</p><ul><li>Bit1 == 0 Not charging</li><li>Bit1 == 1 Charging</li></ul></li><li><p>Bit2 Battery discharging</p><ul><li>Bit2 == 0 Not discharging</li><li>Bit2 == 1 Discharging</li></ul></li><li><p>Bit3 Positive load power</p><ul><li>Bit3 == 0 Load is reactive</li><li>Bit3 == 1 Load is active</li></ul></li><li><p>Bit4 Feed-in power</p><ul><li>Bit4 == 0 No power feed-in the grid</li><li>Bit4 == 1 Power feed-in the grid</li></ul></li><li><p>Bit5 Import Power from grid</p><ul><li>Bit5 == 0 No power imported from the grid</li><li>Bit5 == 1 Importing power from grid</li></ul></li><li><p>Bit6 Reserved Bit6</p></li><li><p>Bit7 (Refitting System) Negative load power</p><ul><li>Bit7 == 0 No power generated from “Load”</li><li>Bit7== 1 Power generated from “Load”</li></ul></li></ul><p>Mit dieser Information ist es bspw. erst möglich direkt zu ermitteln, ob die Batterie entlädt (Bit 3 ist 1) oder lädt (Bit 2 ist 1). Gleichzeitig kann hiermit ermittelt werden, ob bspw. gerade wirklich ins Netz eingespeist wird (Bit 4 ist 1) oder ob die in Register <code>13009 Export power</code> verzeichnet 3 W nur ein Overshoot aus der Batterie sind (Bit 4 ist 0).</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/modbus/blockly.png data-srcset="/images/modbus/blockly.png, /images/modbus/blockly.png 1.5x, /images/modbus/blockly.png 2x" data-sizes=auto alt=/images/modbus/blockly.png title=/images/modbus/blockly.png></p><p>Da die Bitmaske in IoBroker als Dezimalwert dargestellt wird (bspw. <code>25</code>) kursieren einige Beispiele in denen auf diese Werte geprüft wird. Korrekt ist es allerdings so nicht. Folgende JS Funktion kann in Blockly eingebunden werden um zu prüfen, ob ein bestimmtes Bit gesetzt ist:</p><pre tabindex=0><code class="language-javascript=" data-lang="javascript=">function decToBit(dec, bitPosition) {
    return (dec &amp; (1 &lt;&lt; bitPosition)) === 0 ? false : true;
}
</code></pre><p>Nun kann wie folgt geprüft werden, ob die Batterie lädt oder entlädt:</p><pre tabindex=0><code class="language-javascript=" data-lang="javascript=">$runningState = getState(&#34;modbus.0.inputRegisters.13000_Running_State&#34;).val;
$batteryCharging = decToBit($runningState, 1);
$batteryDischarging = decToBit($runningState, 2);
</code></pre><h3 id=wohin-fließt-der-strom>Wohin fließt der Strom?</h3><p>Um mit dieser neuen Information tatsächlich zu bestimmen, von wo nach wo der Strom fließt, sind weitere Überlegungen nötig. Hierzu lässt sich folgende Priorisierung aufstellen:</p><ol><li><p>PV Strom</p><ul><li>speist zunächst die Hauslast</li><li>dann die Batterie</li><li>Rest wird ins Netz eingespeist</li></ul></li><li><p>Strom aus der Batterie</p><ul><li>speist zunächst die Hauslast</li><li>dann das Netz (bspw. Kalibrierung)</li></ul></li><li><p>Strom aus dem Netz</p><ul><li>speist zunächst die Hauslast</li><li>dann die Batterie (bspw. Kalibrierung)</li></ul></li></ol><p>Folgender Auszug aus Blockly / Javascript ermöglicht das Ganze: Wichtig ist, dass bei Aktualisierung des &ldquo;Betriebstatus&rdquo; und/oder der &ldquo;Wirkleistung gesamt&rdquo; die Methode <code>extractRunningStates</code> aufgerufen wird und dieser als Parameter der Wert des Betriebstatus übergeben wird.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/modbus/extractRunningStates.png data-srcset="/images/modbus/extractRunningStates.png, /images/modbus/extractRunningStates.png 1.5x, /images/modbus/extractRunningStates.png 2x" data-sizes=auto alt=/images/modbus/extractRunningStates.png title=/images/modbus/extractRunningStates.png></p><p>Die Methode <code>extractRunningState</code> nimmt den Betriebstatus als Variable <code>dec</code> entgegen und sieht wie folgt aus:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>decToBit</span>(<span style=color:#a6e22e>dec</span>, <span style=color:#a6e22e>bitPosition</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (<span style=color:#a6e22e>dec</span> <span style=color:#f92672>&amp;</span> (<span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#a6e22e>bitPosition</span>)) <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>?</span> <span style=color:#66d9ef>false</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Creates a state if it does not exist yet
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>createStateIfNotExists</span>(<span style=color:#a6e22e>state</span>, <span style=color:#a6e22e>name</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>// createState(state, 0, true, {name: name,  type: &#34;number&#34;, role: &#39;value&#39;}, function () {});    
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> ( <span style=color:#f92672>!</span><span style=color:#a6e22e>existsState</span>(<span style=color:#a6e22e>state</span> )) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>createState</span>(<span style=color:#a6e22e>state</span>, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>false</span>, {<span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>name</span>,  <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;number&#34;</span>, <span style=color:#a6e22e>role</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;value&#39;</span>}, <span style=color:#66d9ef>function</span> () {});    
</span></span><span style=display:flex><span>    } 
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Create states
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>createStateIfNotExists</span>(<span style=color:#e6db74>&#34;0_userdata.0.PV.PvToLoad&#34;</span>, <span style=color:#e6db74>&#34;Power from PV to load&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>createStateIfNotExists</span>(<span style=color:#e6db74>&#34;0_userdata.0.PV.PvToBat&#34;</span>, <span style=color:#e6db74>&#34;Power from PV to bat&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>createStateIfNotExists</span>(<span style=color:#e6db74>&#34;0_userdata.0.PV.PvToGrid&#34;</span>, <span style=color:#e6db74>&#34;Power from PV to grid&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>createStateIfNotExists</span>(<span style=color:#e6db74>&#34;0_userdata.0.PV.BatToLoad&#34;</span>, <span style=color:#e6db74>&#34;Power from Bat to load&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>createStateIfNotExists</span>(<span style=color:#e6db74>&#34;0_userdata.0.PV.BatToGrid&#34;</span>, <span style=color:#e6db74>&#34;Power from Bat to grid&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>createStateIfNotExists</span>(<span style=color:#e6db74>&#34;0_userdata.0.PV.GridToLoad&#34;</span>, <span style=color:#e6db74>&#34;Power from grid to load&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>createStateIfNotExists</span>(<span style=color:#e6db74>&#34;0_userdata.0.PV.GridToBat&#34;</span>, <span style=color:#e6db74>&#34;Power from Gridto battery&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>createStateIfNotExists</span>(<span style=color:#e6db74>&#34;0_userdata.0.PV.SignedBat&#34;</span>, <span style=color:#e6db74>&#34;Battery but with minus sign for charging&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Decode running state flags
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>$powerGeneratedFromPV</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>decToBit</span>(<span style=color:#a6e22e>dec</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>$batteryCharging</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>decToBit</span>(<span style=color:#a6e22e>dec</span>, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>$batteryDischarging</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>decToBit</span>(<span style=color:#a6e22e>dec</span>, <span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>$loadActive</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>decToBit</span>(<span style=color:#a6e22e>dec</span>, <span style=color:#ae81ff>3</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>$powerFeedIntoGrid</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>decToBit</span>(<span style=color:#a6e22e>dec</span>, <span style=color:#ae81ff>4</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>$powerImportFromGrid</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>decToBit</span>(<span style=color:#a6e22e>dec</span>, <span style=color:#ae81ff>5</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>$powerGeneratedFromLoad</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>decToBit</span>(<span style=color:#a6e22e>dec</span>, <span style=color:#ae81ff>7</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Save running state more speaking fields
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>setState</span>(<span style=color:#e6db74>&#34;0_userdata.0.PV.PowerGeneratedFromPV&#34;</span>, <span style=color:#a6e22e>$powerGeneratedFromPV</span>, <span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>setState</span>(<span style=color:#e6db74>&#34;0_userdata.0.PV.BatteryCharging&#34;</span>, <span style=color:#a6e22e>$batteryCharging</span>, <span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>setState</span>(<span style=color:#e6db74>&#34;0_userdata.0.PV.BatteryDischarging&#34;</span>, <span style=color:#a6e22e>$batteryDischarging</span>, <span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>setState</span>(<span style=color:#e6db74>&#34;0_userdata.0.PV.LoadActive&#34;</span>, <span style=color:#a6e22e>$loadActive</span>, <span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>setState</span>(<span style=color:#e6db74>&#34;0_userdata.0.PV.PowerFeedIntoGrid&#34;</span>, <span style=color:#a6e22e>$powerFeedIntoGrid</span>, <span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>setState</span>(<span style=color:#e6db74>&#34;0_userdata.0.PV.PowerImportFromGrid&#34;</span>, <span style=color:#a6e22e>$powerImportFromGrid</span>, <span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>setState</span>(<span style=color:#e6db74>&#34;0_userdata.0.PV.PowerGeneratedFromLoad&#34;</span>, <span style=color:#a6e22e>$powerGeneratedFromLoad</span>, <span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Read current power levels of bat, pv, load and grid
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>$load</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>getState</span>(<span style=color:#e6db74>&#34;modbus.0.inputRegisters.13007_Load_power_&#34;</span>).<span style=color:#a6e22e>val</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>$grid</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>getState</span>(<span style=color:#e6db74>&#34;modbus.0.inputRegisters.13009_Export_power&#34;</span>).<span style=color:#a6e22e>val</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>$pv</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>getState</span>(<span style=color:#e6db74>&#34;modbus.0.inputRegisters.5016_Total_DC_Power&#34;</span>).<span style=color:#a6e22e>val</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>$battery</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>getState</span>(<span style=color:#e6db74>&#34;modbus.0.inputRegisters.13021_Battery_power_&#34;</span>).<span style=color:#a6e22e>val</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Write signed bat
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>setState</span>(<span style=color:#e6db74>&#34;0_userdata.0.PV.SignedBat&#34;</span>, <span style=color:#a6e22e>$batteryCharging</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>$battery</span> <span style=color:#f92672>*</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>:</span> <span style=color:#a6e22e>$battery</span>, <span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Calculate PV
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>$pvToBat</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>$pvToLoad</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>$pvToGrid</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>$loadRemaining</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>$load</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>$powerGeneratedFromPV</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>$remaining</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>$pv</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>$remaining</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>$loadRemaining</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>$pvToLoad</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>$loadRemaining</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>$remaining</span> <span style=color:#f92672>-=</span> <span style=color:#a6e22e>$load</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>$loadRemaining</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>$pvToLoad</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>$remaining</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>$loadRemaining</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>$load</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>$remaining</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>$remaining</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>$batteryCharging</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>$remaining</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>$battery</span>) {            
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>$pvToBat</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>$battery</span>;
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>$remaining</span> <span style=color:#f92672>-=</span> <span style=color:#a6e22e>$battery</span>;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {            
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>$pvToBat</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>$remaining</span>;
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>$remaining</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>$grid</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>$pvToGrid</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>min</span>(<span style=color:#a6e22e>$grid</span>, <span style=color:#a6e22e>$remaining</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>setState</span>(<span style=color:#e6db74>&#34;0_userdata.0.PV.PvToLoad&#34;</span>, <span style=color:#a6e22e>$pvToLoad</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>setState</span>(<span style=color:#e6db74>&#34;0_userdata.0.PV.PvToBat&#34;</span>, <span style=color:#a6e22e>$pvToBat</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>setState</span>(<span style=color:#e6db74>&#34;0_userdata.0.PV.PvToGrid&#34;</span>, <span style=color:#a6e22e>$pvToGrid</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Calculate Bat
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>$batToLoad</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>$batToGrid</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>$batteryDischarging</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>$remaining</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>$battery</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>$remaining</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>$loadRemaining</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>$batToLoad</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>$loadRemaining</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>$remaining</span> <span style=color:#f92672>-=</span> <span style=color:#a6e22e>$loadRemaining</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>$loadRemaining</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>$batToLoad</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>$remaining</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>$loadRemaining</span> <span style=color:#f92672>-=</span> <span style=color:#a6e22e>$remaining</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>$remaining</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;        
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>$powerFeedIntoGrid</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>$batToGrid</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>min</span>(<span style=color:#a6e22e>$grid</span>, <span style=color:#a6e22e>$remaining</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>setState</span>(<span style=color:#e6db74>&#34;0_userdata.0.PV.BatToLoad&#34;</span>, <span style=color:#a6e22e>$batToLoad</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>setState</span>(<span style=color:#e6db74>&#34;0_userdata.0.PV.BatToGrid&#34;</span>, <span style=color:#a6e22e>$batToGrid</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Calculate grid
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>$gridToBat</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>$gridToLoad</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>$grid</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>$remaining</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>abs</span>(<span style=color:#a6e22e>$grid</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>$remaining</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>$loadRemaining</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>$gridToLoad</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>$loadRemaining</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>$remaining</span> <span style=color:#f92672>-=</span> <span style=color:#a6e22e>$loadRemaining</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>$loadRemaining</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>$gridToLoad</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>$remaining</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>$loadRemaining</span> <span style=color:#f92672>-=</span> <span style=color:#a6e22e>$remaining</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>$remaining</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;        
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>$batteryCharging</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>$gridToBat</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>min</span>(<span style=color:#a6e22e>$battery</span>, <span style=color:#a6e22e>$remaining</span>);;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>setState</span>(<span style=color:#e6db74>&#34;0_userdata.0.PV.GridToLoad&#34;</span>, <span style=color:#a6e22e>$gridToLoad</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>setState</span>(<span style=color:#e6db74>&#34;0_userdata.0.PV.GridToBat&#34;</span>, <span style=color:#a6e22e>$gridToBat</span>);
</span></span></code></pre></div><p>Mit dieser Logik lässt sich die Sungrow-Darstellung nährungsweise nachbilden:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/modbus/jarvis-app.png data-srcset="/images/modbus/jarvis-app.png, /images/modbus/jarvis-app.png 1.5x, /images/modbus/jarvis-app.png 2x" data-sizes=auto alt=/images/modbus/jarvis-app.png title=/images/modbus/jarvis-app.png></p><p>In diesem Fall wird neben dem PV-Ertrag oben auch angezeigt, wie viel VA Leistung von den beiden Strings kommen (Ost/West Ausrichtung).</p><h3 id=regelverluste>Regelverluste</h3><p>Auch wenn über die Running States sehr klar ersichtlich ist, ob gerade ins Netz eingespeist oder der Akku geladen wird: Regelverluste (also bspw. kurzzeitge Einspeisungen aus dem Akku ins Netz, die entstehen weil die Last im Haus schneller abgefallen ist als der Akku abregeln konnte) werden über die Running States nicht immer korrekt wiedergegeben. Insofern kann es sinnvoll sein davon auszugehen, dass die 30W, die vom Akku abgehen und nicht mehr zur Hauslast passen, eben doch ins Netz gehen - selbst wenn Bit 4 (power feed in) nicht gesetzt ist.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2022-10-09</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://noegel.io/posts/2022-10-09-sungrow/ data-title="Sungrow Wechselrichter mit Modbus in Iobroker in Echtzeit auslesen" data-via=danielnoegel><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://noegel.io/posts/2022-10-09-sungrow/><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://noegel.io/posts/2022-10-09-sungrow/ data-title="Sungrow Wechselrichter mit Modbus in Iobroker in Echtzeit auslesen"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://noegel.io/posts/2022-10-09-sungrow/ data-title="Sungrow Wechselrichter mit Modbus in Iobroker in Echtzeit auslesen"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://noegel.io/posts/2022-10-09-sungrow/ data-title="Sungrow Wechselrichter mit Modbus in Iobroker in Echtzeit auslesen"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/2022-10-12-gaszaehler/ class=next rel=next title="Auf Irrwegen: Gaszähler automatisch auszulesen">Auf Irrwegen: Gaszähler automatisch auszulesen<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.104.3">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><span class=imprint><a href=https://noegel.io/data-privacy/>Datenschutz</a></span><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank></a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:60,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body><script>document.getElementsByTagName("figure");var list=document.getElementsByTagName("figure"),idx,img,caption,modal=document.getElementById("myModal"),captionText=document.getElementById("caption"),modalImg=document.getElementById("img01"),span=document.getElementsByClassName("closeModal")[0];modal.isVisible=!1,idx=-1;for(let e of list){if(idx++,img=e.getElementsByTagName("img")[0],img===void 0)continue;if(img.idx=idx,caption=e.getElementsByTagName("figcaption")[0],caption!==void 0&&(img.alt=caption.innerText),e.className==="book_cover")continue;img.onclick=function(){modalShow(this)}}span.onclick=function(){modalHide()},modal.onclick=function(){modalHide()};function modalShow(e){modal.style.display="block",modalImg.src=e.src,captionText.innerHTML=e.alt,modal.imgIdx=e.idx,modal.isVisible=!0}function modalHide(){modal.style.display="none",modal.isVisible=!1}function showImage(e){var n=list[e],t=n.getElementsByTagName("img")[0];if(t===void 0)return;modalShow(t)}document.onkeydown=function(e){e=e||window.event;var t,n,s=!1;"key"in e?(t=e.key==="Escape"||e.key==="Esc",n=e.key==="ArrowLeft",s=e.key==="ArrowRight"):(t=e.keyCode===27,n=e.keyCode===37,s=e.keyCode===39),t&&modalHide(),modal.isVisible&&(s&&showImage(Math.min(modal.imgIdx+1,list.length-1)),n&&showImage(Math.max(0,modal.imgIdx-1)))}</script></html>