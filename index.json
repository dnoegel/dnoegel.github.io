[{"categories":null,"content":"Gasz√§hler mit ESP32 und einem QMC5883 Sensor automatisch auslesen","date":"2022-10-18","objectID":"/posts/2022-10-12-gaszaehler/","tags":null,"title":"Auf Irrwegen: Gasz√§hler automatisch auszulesen","uri":"/posts/2022-10-12-gaszaehler/"},{"categories":null,"content":"Smart Home und der mitleidige Blick meiner Ehefrau, wenn ich ihr mal wieder eine Automatisierung oder eine neue Sensor√ºberwachung pr√§sentiere: Diese beiden Sachen gehen Hand in Hand. Das war auch wieder bei diesem Projekt der Fall: Der automatischen √úberwachung des Gasz√§hlers. ","date":"2022-10-18","objectID":"/posts/2022-10-12-gaszaehler/:0:0","tags":null,"title":"Auf Irrwegen: Gasz√§hler automatisch auszulesen","uri":"/posts/2022-10-12-gaszaehler/"},{"categories":null,"content":"Warum das Ganze Ich erfasse immer schon monatlich unseren Strom- und Gasverbrauch. Bisher h√§ndisch: Einmal im Monat ein Foto von beiden Z√§hlern - und bei Zeiten dann in Excel eingepflegt. Fertig. Im Rahmen der D√§mmung unseres Hauses sowie der Heizlastberechnung wollte ich aber genauer verstehen, wie (schnell) sich der Erdgasverbauch entwickelt. Wie so oft: Das Ganze war doch komplizierter als gedacht. ","date":"2022-10-18","objectID":"/posts/2022-10-12-gaszaehler/:1:0","tags":null,"title":"Auf Irrwegen: Gasz√§hler automatisch auszulesen","uri":"/posts/2022-10-12-gaszaehler/"},{"categories":null,"content":"Das Grundprinzip In einigen Gasz√§hlern - so auch in meinem G4 RF1 - finden sich Magneten in einer Walze der Segmentanzeige. Positioniert man einen Reed-Kontakt an die richtige Position, kann dieser recht zuverl√§ssig detektieren, wenn sich die Walze beispielsweise von 9 nach 0 weiter dreht, weil dann eben auch der Magnet am Kontakt vorbeigef√ºhrt wird. Passende Kontakte / Sensoren gibt es direkt vom Hersteller - der l√§sst sich das mit 50-60‚Ç¨ aber auch gut verg√ºten. In solchen F√§llen ist ‚Äúselber machen‚Äù immer eine gute Option - und auch mindestens eine ebensogute Ausrede, den gleichen Betrag in Zubeh√∂r und Werkzeug zur Umsetzung des Projektes zu investieren ;-). In meinem Fall ist auf dem Gasz√§hler √ºbrigens vermerkt, dass 1 Impuls 0,1m¬≥ entspricht - demzufolge findet sich der Magnet auf der zweiten Walze nach dem Komma (eine volle Umdrehung der zweiten Nachkommastelle entspricht einem 1er-Inkrement der ersten Nachkommastelle). ","date":"2022-10-18","objectID":"/posts/2022-10-12-gaszaehler/:2:0","tags":null,"title":"Auf Irrwegen: Gasz√§hler automatisch auszulesen","uri":"/posts/2022-10-12-gaszaehler/"},{"categories":null,"content":"Versuch 1: Der Aqara T√ºr- und Fensterkontakt Im Netz finden sich verschiedene Berichte, dass ein Aqara T√ºr- und Fensterkontakt genutzt werden kann, um die Impulse zu messen. Diese L√∂sung w√§re nat√ºrlich besonders charmant, da ich (a) solche Kontakte ohnehin zu Hause habe, (b) die Sensoren sehr lange batteriebetrieben laufen und sie (c) sehr einfach √ºber Zigbee in das bestehende Hausautomatisierungssystem eingebunden werden k√∂nnen. Die Idee ist einfach: Sensor aus der Plastikh√ºlle befreien, an die richtige Stelle auf den Gasz√§hler platzieren - fertig‚Ä¶ ‚Ä¶oder auch nicht. Aquara T√ºr- und Fenstersensor im Auslieferungszustand Die untere Kappe des Kontaktes l√§sst sich leicht √∂ffnen Mit einem Messer l√§sst sich auch leicht der Rest zerst√∂rungsfrei √∂ffnen (anders als im Bild gezeigt ;-)) Der Sensor wird in die entsprechende Aufnahme platziert. Das Glasr√∂hrchen mit dem Reed-Kontakt sollte grob oberhalb der zweiten Nachkommastelle liegen, da sich in dieser Walze der Magnet befindet Kein Signal: Die n√§chsten Tage habe ich den Sensor in alle m√∂glichen und unm√∂glichen Positionen und Ausrichtungen an den Gasz√§hler geklebt. Ohne Erfolg Trotz aller Bem√ºhungen - und gut 10 abenteuerlichen Klebepositionen: Der Sensor erkennt den Magneten nicht, egal wie oft dieser im Betrieb am Sensor vor√ºber zieht. Das Problem ist bekannt - nicht jede Kombination aus Gasz√§hlerfabrikat und Aqara-Sensor scheint zu funktionieren. ","date":"2022-10-18","objectID":"/posts/2022-10-12-gaszaehler/:3:0","tags":null,"title":"Auf Irrwegen: Gasz√§hler automatisch auszulesen","uri":"/posts/2022-10-12-gaszaehler/"},{"categories":null,"content":"Versuch 2: IP Webcam Im n√§chsten Versuch sollte ein altes Handy als IP Webcam herhalten - ehrlicherweise nur um die Zeit zu √ºberbr√ºcken, bis das Zubeh√∂r f√ºr Versuch 3 eingetroffen ist. Mit einer entsprechenden App lassen sich alte Android Ger√§te relativ leicht als IP Webcam betreiben. Die App bietet umfangreiche Konfigurationsoptionen, letztlich ben√∂tige ich aber nur folgende Gegebenheiten: Bild l√§sst sich via URL auslesen LED-Licht l√§sst sich via HTTP-API ein- und abschalten So bekomme ich nun st√ºndlich einen aktuellen Z√§hlerstand via Telegram-Nachricht mitgeteilt - dank LED Licht auch in der Nacht gut lesbar. Nur aus Interesse habe ich versucht, die Bilder auch automatisiert auszuwerten - zumindest via SSOCR ist es mir aber nicht gelungen. W√ºrde man so etwas zum Laufen bringen wollen - ein Blick auf AI on the edge w√§re sicher lohnenswert: Dort werden Wasserz√§hler mittels ESP32 und einem neuronalem Netzwerk ausgelesen. Entsprechende Trainingsdaten inklusive‚Ä¶ Ein ausgemustertes Handy √ºberwacht den Gasz√§hler Der Versuch die Bilder automatisch zu verarbeiten‚Ä¶ scheitert aber: SSOCR erkennt maximal 3 Ziffern Wenn es schon mit der automatischen Auswertung nicht klappt: Dieses Blockly schickt st√ºndlich‚Ä¶ ‚Ä¶Telegram-Nachrichten mit dem aktuellen Z√§hlerstand ü•¥ Eine Erkenntnis ist aber: Alte Handys lassen sich doch sehr gut als IP Webcam umfunktionieren: Bewegungserkennung, Zwei-Wege-Kommunikation, LED-Licht, Video, Automatische Aufnahmen‚Ä¶ alles m√∂glich. ","date":"2022-10-18","objectID":"/posts/2022-10-12-gaszaehler/:4:0","tags":null,"title":"Auf Irrwegen: Gasz√§hler automatisch auszulesen","uri":"/posts/2022-10-12-gaszaehler/"},{"categories":null,"content":"Versuch 3: Kompass Nachdem klar war, dass der Sensor des Aqara-Kontaktes nicht fein genug ist, um den Magneten zu registrieren, habe ich nach Alternativen geschaut. Die Optionen: Reed-Kontakt Hall-Sensor Kompass/Magnetometer Nachdem ich mit dem Reed-Kontakt im Aqara-Sensor schon auf die Nase gefallen war, habe ich zun√§chst in Richtung Hall-Sensor √ºberlegt. Auch hier finden sich aber unterschiedliche Berichte, welcher Sensor f√ºr diesen Zweck jetzt empflindlich genug ist. Zu guter Letzt habe ich aber ein Projekt gefunden, wo ein Magnetometer HMC5883 mit Raspberry Pi die Aufgabe √ºbernimmt. Die √úberlegung, dass ein Sensor, der das Erdmagnetfelt detektieren kann, auch den Magneten im Gasz√§hler detektieren k√∂nnen sollte, fand ich plausibel. Der Sensor QMC5883 wird mit Stifleisten versehen Nachdem ich den ersten Sensor beim Anl√∂ten der Stiftleisten frittiert hatte und die Ersatzlieferung eingetroffen war, konnte das Projekt umgesetzt werden. Material: ESP32 Microprozessor QMC5833 Kompass Breadboard Jumperkabel Werkzeug: L√∂tkolben Die Idee: Der ESP32 w√§hlt sich ins Wifi ein und √ºbermittelt die Impulse via MQTT an meine Iobroker-Instanz, wo bei jedem Impuls der Z√§hlerstand um 0,1m¬≥ erh√∂ht wird. Springt die zweite Nachkommastelle von 6 auf 7 (rechts im Video), erkennt der Kompass einen starken Ausschlag (links im Video). So lassen sich wiederum Inkremente der ersten Nachkommastelle detektieren Das Sketch daf√ºr ist relativ simpel: Im Wesentlichen werden 10 Sekunden lang Messwerte des Magnetfeldes gesammelt. Da der Sensor relativ empfindlich ist und die Werte bei Erkennung des Magneten √ºberlaufen k√∂nnen, wird die Signalst√§rke auf 4000 beschr√§nkt. Ist der Durchschnittswert der letzten 10 Sekunden \u003e 2000, wird das high Flag gesetzt. Ist der Durchschnittswert der letzten 10 Sekunden kleiner 300 und das High-Flag ist gesetzt, wurde eine Rotation erkannt, das high Flag wird entfernt und das Ganze via MQTT publiziert. Die Erkennung basiert also auf Anstieg und anschlie√üendem Fall der gemessenen Feldst√§rke. Dieses Vorgehen erscheint mir relativ robust, weil es wenig Fehlausl√∂sungen gibt - selbst wenn der Magnet l√§ngere Zeit direkt unter dem Sensor stehen bleibt. Das w√§re anders, wenn der Trigger f√ºr high und der Trigger f√ºr low identisch w√§ren - bei ung√ºnstiger Positionierung des Magneten k√∂nnte der Sensor zwischen den Ausl√∂sewerten hin- und herspringen. void loop() { loopMqtt(); sVector_t mag = compass.readRaw(); // calculate field strength \u0026 store for average calculation fieldStrength = sqrt(mag.XAxis ^ 2 + mag.YAxis ^ 2 + mag.ZAxis ^ 2); avg = avgFieldStrength.reading(fieldStrength \u003e 4000 ? 4000 : fieldStrength); Serial.print(\"Arrow: \"); Serial.println(fieldStrength); // every 10 seconds: evaluate if signall falls from high (magnet detected) to low (no magnet) if ((unsigned long)(millis() - timer) \u003e 10000) { if (avg \u003c 300 and isHigh) { isHigh = false; client.publish(\"mqtt.0.gas_meter.tick\", itoa(millis(), charBuf, 10)); } if (avg \u003e 2000) { isHigh = true; } timer = millis(); } delay(500); } Das komplette Skript findet sich auf Github. ","date":"2022-10-18","objectID":"/posts/2022-10-12-gaszaehler/:5:0","tags":null,"title":"Auf Irrwegen: Gasz√§hler automatisch auszulesen","uri":"/posts/2022-10-12-gaszaehler/"},{"categories":null,"content":"Fazit Insgesamt bin ich ziemlich zufrieden mit dem Ergebnis: Zumindest gibt es nach einem Tag noch keine Abweichung, der erfasste Z√§hlerstand entspricht (bis auf die erste Nachkommastelle) genau dem tats√§chlichen Z√§hlerstand. Und via Iobroker/Jarvis kann ich den Tagesverbauch auch sehr leicht graphisch visualisieren lassen. Nach 24 Stunden hat der Sensor alle 16 Ticks korrekt erfasst ","date":"2022-10-18","objectID":"/posts/2022-10-12-gaszaehler/:6:0","tags":null,"title":"Auf Irrwegen: Gasz√§hler automatisch auszulesen","uri":"/posts/2022-10-12-gaszaehler/"},{"categories":null,"content":" Moin üëã, ich bin Daniel und besch√§ftige mich seit gut 25 Jahren intensiv mit Computersachen. Diese Seite dient dazu, einige dieser Dinge festzuhalten in der Hoffnung dass sie n√ºtzlich sind; und mehr noch in der Hoffnung, dass ich sie schnell wiederfinde, wenn ich sie wieder ben√∂tige. Mehr Informationen gibt‚Äôs an den √ºblichen Orten: ","date":"2022-10-09","objectID":"/about/:0:0","tags":null,"title":"About","uri":"/about/"},{"categories":null,"content":"Sungrow Wechselrichter mit Modbus in Iobroker in Echtzeit auslesen","date":"2022-10-09","objectID":"/posts/2022-10-09-sungrow/","tags":null,"title":"Sungrow Wechselrichter mit Modbus in Iobroker in Echtzeit auslesen","uri":"/posts/2022-10-09-sungrow/"},{"categories":null,"content":"Endlich ist es soweit: 9,75kwp Photovoltaik schimmern im Sonnenlicht auf dem Dach - mit Wechselrichter und Speicher von Sungrow. Die n√ºtzliche App des Anbieters mit all ihren Analysem√∂glichkeiten kann aber nur kurz den Wunsch nach einem direkteren Zugriff auf die Daten zwecks Einbindung in die Hausautomatisierung stillen. Nach einigem Experimentieren funktioniert der Zugriff nun - die Erfahrung m√∂chte ich teilen. ","date":"2022-10-09","objectID":"/posts/2022-10-09-sungrow/:0:0","tags":null,"title":"Sungrow Wechselrichter mit Modbus in Iobroker in Echtzeit auslesen","uri":"/posts/2022-10-09-sungrow/"},{"categories":null,"content":"Kurze Einf√ºhrung √úber die Modbus-Schnittstelle des Wechselrichters k√∂nnen verschiedene Daten der Photovoltaik-Anlage ermittelt werden, wie beispielsweise: Ertrag der Anlage (Momentan und Tagessumme) Eigenbedarf (Momentan und Tagessumme) Einspeisung/Bezug ins/aus dem Netz (Momentan und Tagessumme) Lade- und Entladestrom der Batterie (Momentan und Tagessumme) Verschiedene Monatswerte Spannung und Strom der Strings Ladestand der Anlage Aktuell lese ich etwa 100 Werte aus - davon werden nat√ºrlich nicht alle ben√∂tigt. Grunds√§tzlich ist der Modbus-Standard unabh√§ngig von der eingesetzten Hausautomatisierungsl√∂sung - ich nutze in meinem Fall Iobroker, auch mit anderen Tools und Skripten lassen sich die Daten bei Bedarf verarbeiten. ","date":"2022-10-09","objectID":"/posts/2022-10-09-sungrow/:1:0","tags":null,"title":"Sungrow Wechselrichter mit Modbus in Iobroker in Echtzeit auslesen","uri":"/posts/2022-10-09-sungrow/"},{"categories":null,"content":"Einrichtung ","date":"2022-10-09","objectID":"/posts/2022-10-09-sungrow/:2:0","tags":null,"title":"Sungrow Wechselrichter mit Modbus in Iobroker in Echtzeit auslesen","uri":"/posts/2022-10-09-sungrow/"},{"categories":null,"content":"Verbindung Beim Standard ‚ÄúModbus √ºber TCP‚Äù kann das Modbus-Ger√§t (hier: der Wechselrichter) einfach √ºber das Heimnetz verbunden werden. Sungrow bietet f√ºr die hier beschriebenen Wechselrichter unterschiedliche Arten der Verbindung an: LAN-Verbindung direkt am Wechselrichter LAN-Verbindung via WiNet-S Dongle Wifi-Verbindung via WiNet-S Dongle Gem√§√ü verschiedenen Foren-Berichten, die auf den Sungrow-Support verweisen, sowie meiner eigenen Erfahrung ist eine Modbus-Verbindung NUR via LAN-Anschluss direkt am Wechselrichter m√∂glich. Der Wechselrichter wird also direkt via LAN-Kabel mit dem Router/Switch im Heimnetz verbunden. ","date":"2022-10-09","objectID":"/posts/2022-10-09-sungrow/:2:1","tags":null,"title":"Sungrow Wechselrichter mit Modbus in Iobroker in Echtzeit auslesen","uri":"/posts/2022-10-09-sungrow/"},{"categories":null,"content":"Installation in IoBroker Installiere den Modbus-Adapter in IoBroker indem ihr im Reiter Instanzen nach Modbus sucht und den Adapter installiert. ","date":"2022-10-09","objectID":"/posts/2022-10-09-sungrow/:2:2","tags":null,"title":"Sungrow Wechselrichter mit Modbus in Iobroker in Echtzeit auslesen","uri":"/posts/2022-10-09-sungrow/"},{"categories":null,"content":"Verbindungseinstellungen Unter Instanzen-\u003eModbus kann der Adapter nun konfiguriert werden. Im Tab Allgemein werden folgende Daten hinterlegt: Partner IP-Adresse: IP eures Sungrow WRs Port: 502 Ger√§te ID: 1, ggf. abweichend Typ: Master Aliases benutzen: Deaktivieren / Nein ","date":"2022-10-09","objectID":"/posts/2022-10-09-sungrow/:2:3","tags":null,"title":"Sungrow Wechselrichter mit Modbus in Iobroker in Echtzeit auslesen","uri":"/posts/2022-10-09-sungrow/"},{"categories":null,"content":"Eingangsregister Die vom Wechselrichter bereitgestellten Informationen m√ºssen aus sog. Registern ausgelesen werden. F√ºr die Anbindung m√ºssen neben Adresse und Datentyp auch L√§nge und Faktor hinterlegt sein, idealerweise auch Einheit und eine kurze Beschreibung zur sp√§teren Identifikation. Da das h√§ndische Hinterlegen der Register nicht praktikabel ist, k√∂nnen diese auch importiert werden. √úber den Doppelpfeil (zweites Icon von links auf der linken Seite) k√∂nnen die Register als TSV (Tab seperated Value) hinterlegt werden. Ein TSV mit den Registern ist hier zu finden. Dort auf ‚ÄúRaw‚Äù klicken um zum TSV zu gelangen. Nach dem Einrichten kann die Konfiguration gespeichert werden. ","date":"2022-10-09","objectID":"/posts/2022-10-09-sungrow/:2:4","tags":null,"title":"Sungrow Wechselrichter mit Modbus in Iobroker in Echtzeit auslesen","uri":"/posts/2022-10-09-sungrow/"},{"categories":null,"content":"Pr√ºfen Im Navigationsbaum kann nun Objekte ge√∂ffnet werden. Unter modbus.0.inputRegisters sollten sich nun die Datenpunkte finden. Hier sollte recht schnell ersichtlich werden, ob die Verbindung funktioniert, bspw. anhand der Register 13001 (PV Erzeugung heute) oder 13007 (Wirkleistung). Sind hier keine oder falsche Werte zu sehen, gibt es Probleme mit der Verbindung. Unter Protokoll in der Navigation finden sich weitere Informationen dazu. ","date":"2022-10-09","objectID":"/posts/2022-10-09-sungrow/:2:5","tags":null,"title":"Sungrow Wechselrichter mit Modbus in Iobroker in Echtzeit auslesen","uri":"/posts/2022-10-09-sungrow/"},{"categories":null,"content":"Fehlerbehandlung Die Modbus-Verbindung des Wechselrichters erscheint teilweise etwas fragil. Im Iobroker-Forum gibt es viele Berichte von Verbindungsproblemen aller Art. Im Folgenden ein paar Tipps dazu: ","date":"2022-10-09","objectID":"/posts/2022-10-09-sungrow/:3:0","tags":null,"title":"Sungrow Wechselrichter mit Modbus in Iobroker in Echtzeit auslesen","uri":"/posts/2022-10-09-sungrow/"},{"categories":null,"content":"Fehleranalyse mit modbus-cli Um zu pr√ºfen ob zumindest die Verbindung zum Wechselrichter funktioniert, k√∂nnen Modbus Tools wie bspw. Modbus-CLI genutzt werden. Ein einfaches Beispiel: daniel@laptop ~ % modbus 192.168.1.123:502 -s 1 4999 192.168.1.123: Durch deine IP ersetzen 502: Modbus Port am WR, idR 502 -s 1: Eure ClientID, idR 1 oder 100 4999: Das Register das ausgelesen werden soll Das Ergebnis sollte nun wie folgt aussehen Parsed 0 registers definitions from 1 files 4999: 2022 0x7e6 Interpretation der R√ºckgabe: 4999: Das ausgelesene Register 2022: Der Wert in dezimal. Hier: Das aktuelle Jahr 2022 0x7e6: Der Wer in hexadezimal. Anstatt des Register 4999 k√∂nnen nat√ºrlich auch beliebige andere Register ausgelesen werden. Aber Achtung: Die Erfahrung zeigt, dass es gerade mit diesem Tool nicht immer leicht ist, die richtigen Datentypen zu hinterlegen - selbst bei korrekter Verbindung kommen so fehlerhafte R√ºckgaben zu stande. Meine Empfehlung daher: Nutzt das Tool eher um sicherzustellen, dass die Verbindung funktioniert und haltet euch nicht damit auf, andere Werte auslesen zu wollen. ","date":"2022-10-09","objectID":"/posts/2022-10-09-sungrow/:3:1","tags":null,"title":"Sungrow Wechselrichter mit Modbus in Iobroker in Echtzeit auslesen","uri":"/posts/2022-10-09-sungrow/"},{"categories":null,"content":"Richtiges Ger√§t finden Antwortet der Einrichtungsassistent ist die IP-Adresse falsch In der Regel werdet ihr den Wechselrichter via WLAN-Stick mit dem Internet verbunden haben und zus√§tzlich √ºber den direkten Anschluss die Modbus-Verbindung vornehmen. Damit hat der Wechselrichter zwei IPs - einmal via WLAN und einmal via LAN. √úber beide IPs ist Modbus auch (theoretisch) erreichbar - ihr m√ºsst nun sicherstellen, dass ihr Modbus √ºber den LAN-Anschluss konfiguriert. Die korrekte IP kann bspw. √ºber Fritzbox gefunden werden: Dort lassen sich unter Heimnetz-\u003eNetzwerk alle Netzwerk-Ger√§te finden. Die Sungrow-Ger√§te haben in der Regel eine Mac-Adresse, die mit ‚ÄúAC‚Äù beginnt (Mac-Adressen ggf. √ºber den mit ‚Äú+/-‚Äù beschrifteten Button oben rechts anzeigen lassen). Weiterhin scheinen sich die Ger√§te als espressif-sungrow oder espressif zu identifizieren. Alternativ kann auch das Netzwerk recht einfach mit nmapnach Ger√§ten durchsucht werden, die auf Port 502 (Modbus) lauschen: daniel@rechner ~ % nmap -p502 --open 192.168.178.1/24 Starting Nmap 7.92 ( https://nmap.org ) at 2022-10-10 13:33 CEST Nmap scan report for espressif.fritz.box (192.168.178.85) Host is up (0.13s latency). PORT STATE SERVICE 502/tcp open mbap Nmap scan report for espressif-sungrow.fritz.box (192.168.178.89) Host is up (0.22s latency). PORT STATE SERVICE 502/tcp open mbap Nmap done: 256 IP addresses (24 hosts up) scanned in 49.12 seconds daniel@rechner ~ % Auch hier f√∂rdert der Scan zwei IPs zu Tage. Welche die richtige ist, offenbart ein einfacher Test: Ruft ihr die IP-Adresse im Browser auf und euch wird ein Setup-Assistent angezeigt, seit ihr mit dem WLAN-Stick verbunden - die IP ist also nicht die richtige f√ºr die Modbus-Verbindung. ","date":"2022-10-09","objectID":"/posts/2022-10-09-sungrow/:3:2","tags":null,"title":"Sungrow Wechselrichter mit Modbus in Iobroker in Echtzeit auslesen","uri":"/posts/2022-10-09-sungrow/"},{"categories":null,"content":"Verbindungsfehler Gef√ºrchtet sind Modbus-Fehler wie error: modbus.0 (21335) Client in error state. warn: modbus.0 (21335) Poll error count: 1 code: {\"err\":\"timeout\",\"timeout\":5000} oder in meinem Fall auch gerne On error: {\"errno\":-104,\"code\":\"ECONNRESET\",\"syscall\":\"read\"} im Iobroker-Protokoll. Eine genaue Ursache scheint nicht immer ersichtlich, empfohlen werden folgende Ma√ünahmen: Penible(!) Pr√ºfung der Konfiguration Sicherstellen dass die Read- und Write-Register keine Fehler enthalten (ggf. alle bis auf ein Register probeweise entfernen) Neuinstallation des Modbus-Adapters (Konfiguration, insb. Register vorher sichern / kopieren) Neustart Wechselrichter Aktualisierung Firmware Wechselrichter Umstecken das Kabels in anderen Switch-Port (in meinem Fall Zyxel, ggf. haben die vielen MODBUS Anfragen ein Limit gerissen?) =\u003e Hat reproduzierbar und mit sofortiger Wirkung zu einer Wiederherstellung der Verbindung gef√ºhrt ","date":"2022-10-09","objectID":"/posts/2022-10-09-sungrow/:3:3","tags":null,"title":"Sungrow Wechselrichter mit Modbus in Iobroker in Echtzeit auslesen","uri":"/posts/2022-10-09-sungrow/"},{"categories":null,"content":"Reduzierung von Abfrageintervallen und Registeranzahl Gerade wenn die Verbindung nach einigen Tagen abbricht und durch Wahl eines anderen LAN-Ports am Router/Switch wiederhergestellt werden kann, sollte gepr√ºft werden, ob nicht ggf. eine zu gro√üe Zahl an Registern in zu kurzer Zeit gelesen wird. M√∂gliche Abhilfe: Reduzierte Anzahl an Registern (Beispiel Gist / RAW) Reduzierte Anzahl an Lese- und Schreiboperationen im Modbus-Adapter durch Anpassung der Konfigirationen Leseinterval, Wartezeit ","date":"2022-10-09","objectID":"/posts/2022-10-09-sungrow/:3:4","tags":null,"title":"Sungrow Wechselrichter mit Modbus in Iobroker in Echtzeit auslesen","uri":"/posts/2022-10-09-sungrow/"},{"categories":null,"content":"Jetzt wird ausgelesen! Ist der WR korrekt in IoBroker eignebunden, ist die Freude zu n√§chst gro√ü. Register wie 5016 Total DC Power 13007 Load power 13009 Export power 13021 Battery power versprechen schnelle Erfolge. Allerdings stehen nicht alle Werte, die in der App ersichtlich sind, auch direkt zum Auslesen zur Verf√ºgung: Im obigen Bild ist bspw. ersichtlich, dass die Last des Hauses mit 83 W aus der PV-Anlage sowie 133 W aus dem Akku bedient wird. Weiterhin speist der Akku mit 2,003 kW ins Netz ein (es handelt sich hierbei um eine Kalibrierung des AKkus, ansonsten tritt der Fall nat√ºrlich nicht auf). Mit den Informationen in den o.g. Registern ist lediglich ersichtlich, dass 83 W PV-Strom erzeugt werden, die Batterie eine Last von 2,136 kW hat und ins Netz 2,003 kW eingespeist werden und im Haus eine Last von 216 W anf√§llt. Wie die Str√∂me sich genau verteilen ist √ºber die Register nicht ersichtlich. Um diese Information zu ermitteln werden die sog. ‚ÄúRunning States‚Äù ben√∂tigt. ","date":"2022-10-09","objectID":"/posts/2022-10-09-sungrow/:4:0","tags":null,"title":"Sungrow Wechselrichter mit Modbus in Iobroker in Echtzeit auslesen","uri":"/posts/2022-10-09-sungrow/"},{"categories":null,"content":"13000_Running_State Im Register 13000 ‚ÄúRunning State‚Äù findet sich der aktuelle Betriebsstatus des Wechselrichters. Hierbei handelt es sich um eine Bitmaske die folgende Informationen kodiert: Bit0 PV power Bit0 == 0 No power generated from PV Bit0 == 1 Power generated from PV Bit1 Battery charging Bit1 == 0 Not charging Bit1 == 1 Charging Bit2 Battery discharging Bit2 == 0 Not discharging Bit2 == 1 Discharging Bit3 Positive load power Bit3 == 0 Load is reactive Bit3 == 1 Load is active Bit4 Feed-in power Bit4 == 0 No power feed-in the grid Bit4 == 1 Power feed-in the grid Bit5 Import Power from grid Bit5 == 0 No power imported from the grid Bit5 == 1 Importing power from grid Bit6 Reserved Bit6 Bit7 (Refitting System) Negative load power Bit7 == 0 No power generated from ‚ÄúLoad‚Äù Bit7== 1 Power generated from ‚ÄúLoad‚Äù Mit dieser Information ist es bspw. erst m√∂glich direkt zu ermitteln, ob die Batterie entl√§dt (Bit 3 ist 1) oder l√§dt (Bit 2 ist 1). Gleichzeitig kann hiermit ermittelt werden, ob bspw. gerade wirklich ins Netz eingespeist wird (Bit 4 ist 1) oder ob die in Register 13009 Export power verzeichnet 3 W nur ein Overshoot aus der Batterie sind (Bit 4 ist 0). Da die Bitmaske in IoBroker als Dezimalwert dargestellt wird (bspw. 25) kursieren einige Beispiele in denen auf diese Werte gepr√ºft wird. Korrekt ist es allerdings so nicht. Folgende JS Funktion kann in Blockly eingebunden werden um zu pr√ºfen, ob ein bestimmtes Bit gesetzt ist: function decToBit(dec, bitPosition) { return (dec \u0026 (1 \u003c\u003c bitPosition)) === 0 ? false : true; } Nun kann wie folgt gepr√ºft werden, ob die Batterie l√§dt oder entl√§dt: $runningState = getState(\"modbus.0.inputRegisters.13000_Running_State\").val; $batteryCharging = decToBit($runningState, 1); $batteryDischarging = decToBit($runningState, 2); ","date":"2022-10-09","objectID":"/posts/2022-10-09-sungrow/:4:1","tags":null,"title":"Sungrow Wechselrichter mit Modbus in Iobroker in Echtzeit auslesen","uri":"/posts/2022-10-09-sungrow/"},{"categories":null,"content":"Wohin flie√üt der Strom? Um mit dieser neuen Information tats√§chlich zu bestimmen, von wo nach wo der Strom flie√üt, sind weitere √úberlegungen n√∂tig. Hierzu l√§sst sich folgende Priorisierung aufstellen: PV Strom speist zun√§chst die Hauslast dann die Batterie Rest wird ins Netz eingespeist Strom aus der Batterie speist zun√§chst die Hauslast dann das Netz (bspw. Kalibrierung) Strom aus dem Netz speist zun√§chst die Hauslast dann die Batterie (bspw. Kalibrierung) Folgendes Javascript √ºbersetzt das Ganze in Code f√ºr IoBroker. function decToBit(dec, bitPosition) { return (dec \u0026 (1 \u003c\u003c bitPosition)) === 0 ? false : true; } // Creates a state if it does not exist yet function createStateIfNotExists(state, name) { if ( !existsState(state )) { createState(state, 0, false, {name: name, type: \"number\", role: 'value'}, function () {}); } } // Create states createStateIfNotExists(\"0_userdata.0.PV.PvToLoad\", \"Power from PV to load\"); createStateIfNotExists(\"0_userdata.0.PV.PvToBat\", \"Power from PV to bat\"); createStateIfNotExists(\"0_userdata.0.PV.PvToGrid\", \"Power from PV to grid\"); createStateIfNotExists(\"0_userdata.0.PV.BatToLoad\", \"Power from Bat to load\"); createStateIfNotExists(\"0_userdata.0.PV.BatToGrid\", \"Power from Bat to grid\"); createStateIfNotExists(\"0_userdata.0.PV.GridToLoad\", \"Power from grid to load\"); createStateIfNotExists(\"0_userdata.0.PV.GridToBat\", \"Power from Gridto battery\"); // Decode running state flags $powerGeneratedFromPV = decToBit(dec, 0); $batteryCharging = decToBit(dec, 1); $batteryDischarging = decToBit(dec, 2); $loadActive = decToBit(dec, 3); $powerFeedIntoGrid = decToBit(dec, 4); $powerImportFromGrid = decToBit(dec, 5); $powerGeneratedFromLoad = decToBit(dec, 7); // Save running state more speaking fields setState(\"0_userdata.0.PV.PowerGeneratedFromPV\", $powerGeneratedFromPV, true); setState(\"0_userdata.0.PV.BatteryCharging\", $batteryCharging, true); setState(\"0_userdata.0.PV.BatteryDischarging\", $batteryDischarging, true); setState(\"0_userdata.0.PV.LoadActive\", $loadActive, true); setState(\"0_userdata.0.PV.PowerFeedIntoGrid\", $powerFeedIntoGrid, true); setState(\"0_userdata.0.PV.PowerImportFromGrid\", $powerImportFromGrid, true); setState(\"0_userdata.0.PV.PowerGeneratedFromLoad\", $powerGeneratedFromLoad, true); // Read current power levels of bat, pv, load and grid $load = getState(\"modbus.0.inputRegisters.13007_Load_power_\").val; $grid = getState(\"modbus.0.inputRegisters.13009_Export_power\").val; $pv = getState(\"modbus.0.inputRegisters.5016_Total_DC_Power\").val; getState(\"modbus.0.inputRegisters.13021_Battery_power_\").val; // Calculate PV $pvToBat = 0; $pvToLoad = 0; $pvToGrid = 0; $loadRemaining = $load; if ($powerGeneratedFromPV) { $remaining = $pv; if ($remaining \u003e $loadRemaining) { $pvToLoad = $loadRemaining; $remaining -= $load; $loadRemaining = 0; } else { $pvToLoad = $remaining; $loadRemaining = $load - $remaining; $remaining = 0; } if ($batteryCharging) { if ($remaining \u003e $battery) { $pvToBat = $battery; $remaining -= $battery; } else { $pvToBat = $remaining; $remaining = 0; } } if ($grid \u003e 0) { $pvToGrid = $remaining; } } setState(\"0_userdata.0.PV.PvToLoad\", $pvToLoad); setState(\"0_userdata.0.PV.PvToBat\", $pvToBat); setState(\"0_userdata.0.PV.PvToGrid\", $pvToGrid); // Calculate Bat $batToLoad = 0; $batToGrid = 0; if ($batteryDischarging) { $remaining = $battery; if ($remaining \u003e $loadRemaining) { $batToLoad = $loadRemaining; $remaining -= $loadRemaining; $loadRemaining = 0; } else { $batToLoad = $remaining; $loadRemaining -= $remaining; $remaining = 0; } if ($powerFeedIntoGrid) { $batToGrid = $remaining; } } setState(\"0_userdata.0.PV.BatToLoad\", $batToLoad); setState(\"0_userdata.0.PV.BatToGrid\", $batToGrid); // Calculate grid $gridToBat = 0; $gridToLoad = 0; if ($grid \u003c 0) { $remaining = Math.abs($grid); if ($remaining \u003e $loadRemaining) { $gridToLoad = $loadRemaining; $remaining -= $loadRemaining; $loadRemaining = 0; } else { $gridToLoad = $remaining; $loadRemaining -= $remaining; $remaining = 0; } if (","date":"2022-10-09","objectID":"/posts/2022-10-09-sungrow/:4:2","tags":null,"title":"Sungrow Wechselrichter mit Modbus in Iobroker in Echtzeit auslesen","uri":"/posts/2022-10-09-sungrow/"},{"categories":null,"content":"Regelverluste Auch wenn √ºber die Running States sehr klar ersichtlich ist, ob gerade ins Netz eingespeist oder der Akku geladen wird: Regelverluste (also bspw. kurzzeitge Einspeisungen aus dem Akku ins Netz, die entstehen weil die Last im Haus schneller abgefallen ist als der Akku abregeln konnte) werden √ºber die Running States nicht immer korrekt wiedergegeben. Insofern kann es sinnvoll sein davon auszugehen, dass die 30W, die vom Akku abgehen und nicht mehr zur Hauslast passen, eben doch ins Netz gehen - selbst wenn Bit 4 (power feed in) nicht gesetzt ist. ","date":"2022-10-09","objectID":"/posts/2022-10-09-sungrow/:4:3","tags":null,"title":"Sungrow Wechselrichter mit Modbus in Iobroker in Echtzeit auslesen","uri":"/posts/2022-10-09-sungrow/"},{"categories":null,"content":"Datenschutz Diese Datenschutzerkl√§rung soll die Nutzer der Webseite √ºber Art, Umfang und Zweck der erhobenen personenbezogenen Daten informieren. ","date":"0001-01-01","objectID":"/data-privacy/:1:0","tags":null,"title":"","uri":"/data-privacy/"},{"categories":null,"content":"Zugriffsdaten Beim Aufrufen von Seiten auf dieser Webseite werden automatisch Zugriffsdaten protokolliert (sog. Server-Logfiles). Dazu geh√∂ren: Besuchte Seiten Zeitpunkt des Zugriffs Gr√∂√üe der gesendeten Daten Quelle des Zugriffs (sog. Referer) Genutzter Browser Genutztes Betriebsystem IP Die so erhobenen Daten werden nach 7 Tage gel√∂scht. Die Erhebung dieser Daten ist unter anderem aus Sicherheitsgr√ºnden erforderlich um beispielsweise Angriffe auf die Webseite analysieren zu k√∂nnen. ","date":"0001-01-01","objectID":"/data-privacy/:1:1","tags":null,"title":"","uri":"/data-privacy/"},{"categories":null,"content":"Statistiken Auf Basis der oben genannten Zugriffsdaten werden automatisiert Statistiken generiert, die der Reichweitenmessung dienen. √úber diese Statistiken k√∂nnen vom Betreiber der Webseite folgende Informationen eingesehen werden: Aufgerufene Seiten (Anzahl, Gr√∂√üe, Verteilung √ºber Tag / Monat / Jahr) Herkunft der Aufrufe (sog. Referer) Anteilige Nutzung nach Browser Anteilige Nutzung nach Betriebssystem Anteilige Nutzung nach L√§ndern Die Statistiken erstrecken sich jeweils √ºber 1 Jahr ","date":"0001-01-01","objectID":"/data-privacy/:1:2","tags":null,"title":"","uri":"/data-privacy/"},{"categories":null,"content":"Kontakt bei Fragen Bei Fragen zum Datenschutz auf dieser Seite wenden Sie sich gerne an mich: fragen-zum-datenschutz@post.noegelmail.de ","date":"0001-01-01","objectID":"/data-privacy/:1:3","tags":null,"title":"","uri":"/data-privacy/"},{"categories":null,"content":"Impressum ","date":"0001-01-01","objectID":"/imprint/:0:0","tags":null,"title":"","uri":"/imprint/"}]